{% extends 'base.html' %}
{% block title %}Stock History{% endblock %}

{% block content %}
<div class="bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-6">

    <!-- Header with search & download -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 space-y-4 sm:space-y-0">
      <h2 class="text-2xl font-semibold text-gray-800">üì¶ Stock History</h2>
      <div class="flex items-center space-x-2 w-full sm:w-auto">
        <!-- Custom search input -->
        <div class="relative flex-1 sm:flex-none">
          <input
            id="historySearch"
            type="text"
            placeholder="Search history‚Ä¶"
            class="w-full sm:w-60 border border-gray-300 rounded-full py-2 px-4 text-sm 
                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
          <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">üîç</span>
        </div>
        <!-- Download button -->
        <a
          href="{{ url_for('download_stock_history', q='') }}"
          class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white text-sm font-medium 
                 px-4 py-2 rounded-full transition-shadow shadow-sm"
        >
          Download Excel
        </a>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table id="stockHistoryTable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Product</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Changed By</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Old Qty</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">New Qty</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Change</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Changed At</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Invoice</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">Remark</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 bg-white">
          {% for row in history %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.product_name }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.changed_by }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.old_quantity }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.new_quantity }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.change_amount }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.changed_at }}</td>
            <td class="px-4 py-2 text-sm">
                            {% if row.invoice_path %}
                                <a
                                href="{{ url_for('download_r2_object', key=row.invoice_path) }}"
                                target="_blank"
                                class="text-indigo-600 hover:underline text-sm"
                                >
                                Download {{ row.invoice_filename }}
                                </a>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ row.remark or '‚Äî' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="px-4 py-6 text-center text-gray-500 italic">
              No stock history found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- DataTables & custom filtering (move CSS/JS into base.html if you prefer) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = $('#stockHistoryTable').DataTable({
      paging: true,
      info: false,
      ordering: true,
      order: [[5, 'desc']],
      lengthChange: false,
      dom: 't<"mt-4"p>'
    });

    $('#historySearch').on('input', function() {
      table.search(this.value).draw();
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const filteredData = table.rows({ search: 'applied' }).data().toArray();
      if (!filteredData.length) return alert("No data to download.");
      
      const headers = ["Product","Changed By","Old Qty","New Qty","Change","Changed At"];
      const csv = [headers, ...filteredData.map(r => r.slice(0,6))]  // first 6 cols
        .map(row => row.join(","))
        .join("\n");
      
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "stock_history.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  });
</script>
{% endblock %}
