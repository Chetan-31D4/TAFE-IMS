{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto p-8 bg-white rounded-xl shadow-lg">
  <h2 class="text-3xl font-semibold mb-6 text-gray-800">ðŸ“¥ Receive New Stock</h2>

  <form method="POST" enctype="multipart/form-data" class="space-y-8">
    <!-- Top Controls: Invoice & Search -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
      <!-- Invoice Upload Dropzone -->
      <label id="invoiceDropzone" for="invoice" class="group flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-green-500 transition-colors">
        <input
          type="file"
          id="invoice"
          name="invoice"
          accept=".pdf"
          required
          class="hidden"
        />
        <div class="text-center">
          <p class="text-gray-500 group-hover:text-green-600 transition-colors">Drag & drop PDF here, or click to browse</p>
          <p class="text-xs text-gray-400">Only .pdf files allowed</p>
          <p id="invoiceFilename" class="text-sm text-gray-600 mt-2"></p>
        </div>
      </label>

      <!-- Product Search -->
      <div>
        <input
          id="stockSearch"
          type="text"
          placeholder="Search products by nameâ€¦"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition"
        />
      </div>
    </div>

    <!-- Products Table -->
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="sticky top-0 px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Product</th>
            <th class="sticky top-0 px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Current Qty</th>
            <th class="sticky top-0 px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Receive Qty</th>
          </tr>
        </thead>
        <tbody id="stockTableBody" class="bg-white divide-y divide-gray-100">
          {% for p in products %}
          <tr class="odd:bg-white even:bg-gray-50 hover:bg-green-50 transition-colors">
            <td class="px-6 py-4 text-sm font-medium text-gray-800">{{ p.name }}</td>
            <td class="px-6 py-4 text-sm text-gray-600">{{ p.quantity }}</td>
            <td class="px-6 py-4">
              <input
                type="number"
                name="qty_{{ p.id }}"
                min="0"
                value="0"
                class="w-24 border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-green-500 transition"
              />
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="px-6 py-4 text-center text-gray-400 italic">No products found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Submit Button -->
    <div class="flex justify-end">
      <button
        type="submit"
        class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg shadow-md transition-all"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 5a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L11 8.414V15a1 1 0 11-2 0V8.414L7.707 9.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 5z" clip-rule="evenodd" />
        </svg>
        Save Received Stock
      </button>
    </div>
  </form>
</div>

<script>
  // File name display and drag & drop
  const invoiceInput = document.getElementById('invoice');
  const invoiceFilename = document.getElementById('invoiceFilename');
  const dropzone = document.getElementById('invoiceDropzone');

  invoiceInput.addEventListener('change', () => {
    const file = invoiceInput.files[0];
    invoiceFilename.textContent = file ? file.name : '';
  });

  ['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      dropzone.classList.add('border-green-500', 'bg-green-50');
    });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      dropzone.classList.remove('border-green-500', 'bg-green-50');
    });
  });
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    if (e.dataTransfer.files.length) {
      invoiceInput.files = e.dataTransfer.files;
      invoiceFilename.textContent = e.dataTransfer.files[0].name;
    }
  });

  // Live search on product name
  document.getElementById('stockSearch').addEventListener('input', function(e) {
    const filter = e.target.value.toLowerCase();
    let anyVisible = false;
    document.querySelectorAll('#stockTableBody tr').forEach(row => {
      const name = row.cells[0].innerText.toLowerCase();
      const show = name.includes(filter);
      row.style.display = show ? '' : 'none';
      if (show) anyVisible = true;
    });
    const tableBody = document.getElementById('stockTableBody');
    const noRow = tableBody.querySelector('.no-results');
    if (!anyVisible) {
      if (!noRow) {
        tableBody.insertAdjacentHTML('beforeend',
          `<tr class="no-results"><td colspan="3" class="px-6 py-4 text-center text-gray-400 italic">No products match your search.</td></tr>`
        );
      }
    } else if (noRow) {
      noRow.remove();
    }
  });
</script>
{% endblock %}
